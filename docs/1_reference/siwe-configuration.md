# SIWE Configuration Guide

This document explains how SIWE (Sign-In with Ethereum) is configured in this project, including environment variables, Vite configuration, frontend usage patterns, and deployment procedures.

## Overview

SIWE (Sign-In with Ethereum) allows users to authenticate with Ethereum wallets on the Internet Computer. This project uses the `ic-siwe` library to implement SIWE authentication.

## Environment Variables

### Configuration

SIWE canister IDs are automatically configured through the `.env` file that gets generated by dfx. The environment variables follow this pattern:

```bash
# DFX CANISTER ENVIRONMENT VARIABLES
DFX_VERSION='0.27.0'
DFX_NETWORK='local'
CANISTER_ID_IC_SIWE_PROVIDER='uzt4z-lp777-77774-qaabq-cai'
CANISTER_ID_FRONTEND='u6s2n-gx777-77774-qaaba-cai'
CANISTER_ID_BACKEND='uxrrr-q7777-77774-qaaaq-cai'
CANISTER_ID='uzt4z-lp777-77774-qaabq-cai'
CANISTER_CANDID_PATH='/path/to/canister/did'
# END DFX CANISTER ENVIRONMENT VARIABLES
```

### Generation

The `.env` file is automatically generated by dfx when you run:

- `dfx deploy` - Deploys canisters and generates environment variables
- `dfx generate` - Generates TypeScript declarations and environment variables

The `dfx.json` configuration specifies the output file:

```json
{
  "output_env_file": ".env",
  "version": 1
}
```

## Vite Configuration

The `vite.config.ts` file is configured to load environment variables with specific prefixes:

```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react-swc";
import dotenv from "dotenv";
import environment from "vite-plugin-environment";
import path from "path";
import wasm from "vite-plugin-wasm";
import topLevelAwait from "vite-plugin-top-level-await";

dotenv.config({ path: ".env" });

export default defineConfig({
  root: "src/frontend",
  build: {
    outDir: "../../dist",
    target: "ES2022",
  },
  optimizeDeps: {
    esbuildOptions: {
      define: {
        global: "globalThis",
      },
    },
  },
  server: {
    proxy: {
      "/api": {
        target: "http://127.0.0.1:4943",
        changeOrigin: true,
      },
    },
  },
  plugins: [
    wasm(),
    topLevelAwait(),
    react(),
    environment("all", { prefix: "CANISTER_" }),
    environment("all", { prefix: "DFX_" }),
  ],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src/frontend/src"),
    },
  },
});
```

### Key Configuration Points

1. **Environment Plugin**: The `vite-plugin-environment` plugin exposes environment variables with `CANISTER_` and `DFX_` prefixes
2. **Dotenv Loading**: The `.env` file is loaded using `dotenv.config({ path: ".env" })`
3. **Build Configuration**: The build target is set to `ES2022` for modern JavaScript features

## Frontend Usage Pattern

### Import Pattern

The frontend accesses the SIWE canister ID through the generated declarations, not through `import.meta.env`:

```typescript
// ‚úÖ Correct pattern
import { canisterId } from "../../ic_siwe_provider/declarations/index";

// ‚ùå Incorrect pattern (don't use this)
// const canisterId = import.meta.env.CANISTER_ID_IC_SIWE_PROVIDER;
```

### SIWE Provider Setup

The SIWE provider is configured in `src/frontend/src/main.tsx`:

```typescript
import { SiweIdentityProvider } from "ic-siwe-js/react";
import { canisterId } from "../../ic_siwe_provider/declarations/index";

ReactDOM.createRoot(rootElement).render(
  <React.StrictMode>
    <WagmiProvider config={wagmiConfig}>
      <QueryClientProvider client={queryClient}>
        <SiweIdentityProvider canisterId={canisterId}>
          <Actors>
            <AuthGuard>
              <App />
              <Toaster />
            </AuthGuard>
          </Actors>
        </SiweIdentityProvider>
      </QueryClientProvider>
    </WagmiProvider>
  </React.StrictMode>
);
```

### Generated Declarations

The canister ID is exported from the generated declarations file (`src/ic_siwe_provider/declarations/index.js`):

```javascript
/* CANISTER_ID is replaced by webpack based on node environment
 * Note: canister environment variable will be standardized as
 * process.env.CANISTER_ID_<CANISTER_NAME_UPPERCASE>
 * beginning in dfx 0.15.0
 */
export const canisterId = process.env.CANISTER_ID_IC_SIWE_PROVIDER;
```

### Browser vs Node.js Environment Handling

**Important**: The `process.env` approach works because Vite's build process handles the environment variable replacement during the build phase, not at runtime in the browser.

#### How It Works:

1. **Build Time**: During `vite build`, Vite replaces `process.env.CANISTER_ID_IC_SIWE_PROVIDER` with the actual canister ID value
2. **Runtime**: In the browser, the code becomes something like:
   ```javascript
   export const canisterId = "uzt4z-lp777-77774-qaabq-cai";
   ```

#### Why This Pattern Works:

- **No Runtime `process` Object**: The browser never sees `process.env` - it's replaced during build
- **Environment Plugin**: The `vite-plugin-environment` plugin handles the replacement
- **Build Optimization**: Vite optimizes this during the build process

#### Alternative Patterns (Don't Use):

```javascript
// ‚ùå This won't work in browsers
const canisterId = process.env.CANISTER_ID_IC_SIWE_PROVIDER;

// ‚ùå This also won't work reliably
const canisterId = import.meta.env.CANISTER_ID_IC_SIWE_PROVIDER;

// ‚úÖ This is the correct pattern (import from declarations)
import { canisterId } from "../../ic_siwe_provider/declarations/index";
```

## Canister Configuration

### dfx.json Configuration

The SIWE provider is configured as a custom canister in `dfx.json`:

```json
{
  "canisters": {
    "ic_siwe_provider": {
      "candid": "https://github.com/kristoferlund/ic-siwe/releases/download/v0.1.1/ic_siwe_provider.did",
      "declarations": {
        "output": "src/ic_siwe_provider/declarations"
      },
      "type": "custom",
      "wasm": "https://github.com/kristoferlund/ic-siwe/releases/download/v0.1.1/ic_siwe_provider.wasm.gz"
    }
  }
}
```

### Canister IDs

The canister IDs are stored in `.dfx/local/canister_ids.json`:

```json
{
  "__Candid_UI": {
    "local": "umunu-kh777-77774-qaaca-cai"
  },
  "backend": {
    "local": "uxrrr-q7777-77774-qaaaq-cai"
  },
  "frontend": {
    "local": "u6s2n-gx777-77774-qaaba-cai"
  },
  "ic_siwe_provider": {
    "local": "uzt4z-lp777-77774-qaabq-cai"
  }
}
```

## Deployment

### Deployment Script

The SIWE provider is deployed using the `scripts/deploy.sh` script:

```bash
#!/bin/bash

set -e          # Exit immediately if a command exits with a non-zero status
set -u          # Treat unset variables as an error
set -o pipefail # Ensure errors propagate in pipelines

dfx canister create --all

dfx deploy ic_siwe_provider --argument "(
    record {
        domain = \"127.0.0.1\";
        uri = \"http://127.0.0.1:5173\";
        salt = \"salt\";
        chain_id = opt 8453;
        scheme = opt \"http\";
        statement = opt \"Login to the vetKeys demo app\";
        sign_in_expires_in = opt 300000000000; /* 5 minutes */
        session_expires_in = opt 604800000000000; /* 1 week */
        targets = opt vec {
            \"$(dfx canister id ic_siwe_provider)\";
            \"$(dfx canister id backend)\";
        };
    }
)"

touch src/backend/build.rs # Touch the build.rs file to retrigger the build

# Generate Candid interface for backend
echo "üîß Generating Candid interface for backend..."
cd src/backend
generate-did backend
cd ../..

dfx generate

dfx deploy backend

dfx deploy frontend
```

### Deployment Arguments

The SIWE provider is deployed with specific arguments:

- **domain**: The domain for the SIWE message (e.g., "127.0.0.1")
- **uri**: The URI for the SIWE message (e.g., "http://127.0.0.1:5173")
- **salt**: A salt value for security
- **chain_id**: The Ethereum chain ID (e.g., 8453 for Base)
- **scheme**: The URI scheme (e.g., "http")
- **statement**: The statement shown to users during sign-in
- **sign_in_expires_in**: How long the sign-in message is valid (5 minutes)
- **session_expires_in**: How long the session is valid (1 week)
- **targets**: List of canister IDs that can be called after authentication

## Troubleshooting

### Common Issues

1. **"Canister ID is required, but received undefined instead"**

   - **Cause**: The canister ID is not being imported from the generated declarations
   - **Solution**: Import from `../../ic_siwe_provider/declarations/index` instead of using `import.meta.env`

2. **"Uncaught ReferenceError: process is not defined" (Critical Browser Issue)**

   - **Cause**: Generated declarations use `process.env` which doesn't exist in browsers
   - **Root Cause**: `process.env` is a Node.js global that's not available in browser environments
   - **Symptoms**: White page, JavaScript errors, React app fails to load
   - **Solution**: Use Vite's `define` option to replace `process.env` with actual values at build time:

   ```typescript
   // vite.config.ts
   export default defineConfig({
     define: {
       "process.env.CANISTER_ID_IC_SIWE_PROVIDER": JSON.stringify(
         process.env.CANISTER_ID_IC_SIWE_PROVIDER
       ),
       "process.env.DFX_NETWORK": JSON.stringify(process.env.DFX_NETWORK),
       // ... other environment variables
     },
     // ... rest of config
   });
   ```

   - **How it works**: Vite replaces `process.env.CANISTER_ID_IC_SIWE_PROVIDER` with `"actual-canister-id"` at build time
   - **Result**: Browser never sees `process.env` references, only the actual string values
   - **Alternative**: Some projects use `vite-plugin-environment` but this may not work reliably

3. **Environment variables not available**

   - **Cause**: The `.env` file hasn't been generated or the vite plugin isn't configured
   - **Solution**: Run `dfx generate` and ensure the environment plugin is configured in `vite.config.ts`

4. **SIWE provider not deployed**
   - **Cause**: The deployment script hasn't been run
   - **Solution**: Run `./scripts/deploy.sh` to deploy all canisters

### Debugging Steps

1. Check if the `.env` file exists and contains the correct canister IDs
2. Verify that `dfx generate` has been run to create the declarations
3. Ensure the vite environment plugin is configured correctly
4. Check that the canister ID is being imported from the declarations file
5. Verify the SIWE provider is deployed with the correct arguments

### Key Questions for SIWE Debugging

When troubleshooting SIWE issues, ask these specific questions:

#### Frontend Access Pattern:

- **How do they access the SIWE canister ID in their frontend?**
- **Do they use `import.meta.env`, `process.env`, or something else?**
- **What's the exact code they use to import the canister ID?**

#### Vite Configuration:

- **How is their Vite configuration set up for SIWE?**
- **What's their `vite.config.ts` configuration for environment variables?**
- **How do they make the canister IDs available to the frontend?**

#### Declarations and Build Process:

- **What's their exact SIWE declarations file?**
- **Can they show the content of their `src/ic_siwe_provider/declarations/index.js`?**
- **How do they export the canister ID?**

#### Browser Environment Handling:

- **How do they handle the browser vs Node.js environment difference?**
- **Since `process.env` doesn't exist in browsers, how do they solve this?**

#### The Solution Pattern:

The working solution uses this pattern:

1. **Build-time replacement**: Vite replaces `process.env.CANISTER_ID_IC_SIWE_PROVIDER` during build
2. **Import from declarations**: Frontend imports from generated declarations, not direct env access
3. **No runtime `process` object**: The browser never sees `process.env` - it's replaced with actual values

## Best Practices

1. **Always use generated declarations**: Import canister IDs from the generated declarations, not from `import.meta.env`
2. **Run dfx generate after deployment**: This ensures the declarations are up to date
3. **Check environment variables**: Verify that the `.env` file contains the expected canister IDs
4. **Use the deployment script**: The provided deployment script handles the correct deployment order and arguments
5. **Test locally first**: Always test the SIWE configuration locally before deploying to mainnet

## References

- [IC SIWE Documentation](https://github.com/kristoferlund/ic-siwe)
- [Vite Environment Plugin](https://github.com/ElMassimo/vite-plugin-environment)
- [DFX Documentation](https://internetcomputer.org/docs/current/developer-docs/setup/dfx/)
